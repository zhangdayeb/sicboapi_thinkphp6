# 🎲 骰宝游戏WebSocket开发需求文档

## 📋 项目概述

### 项目名称
骰宝游戏WebSocket实时推送系统

### 项目背景
基于ThinkPHP6 + Workerman框架，使用PHP 7.3版本，为骰宝游戏提供实时状态推送功能，确保用户能够及时接收游戏状态变化、开奖结果等关键信息。

### 架构原则
- **职责分离**: HTTP API负责数据操作，WebSocket负责实时推送
- **单一数据源**: Redis作为游戏状态的统一存储
- **精简高效**: 只实现必要的实时功能，避免过度设计

---

## 🎯 功能需求

### 1. 核心功能列表

#### 1.1 连接管理
- **用户认证**: 基于user_id + token的简单验证
- **台桌加入/离开**: 用户进入/退出特定游戏台桌
- **连接保活**: ping/pong心跳机制
- **连接清理**: 自动清理无效连接

#### 1.2 实时推送功能

##### 推送1: 开始投注信号
```
触发条件: 荷官通过HTTP接口开始新游戏
推送对象: 指定台桌的所有用户
推送内容: 游戏局号、投注时长、轮次号
```

##### 推送2: 倒计时更新
```
触发条件: 投注时间进行中
推送策略: 
  - 前期: 30秒 → 20秒 → 10秒 (每10秒推送)
  - 后期: 5秒 → 4秒 → 3秒 → 2秒 → 1秒 → 0秒 (逐秒推送)
推送对象: 指定台桌的所有用户
```

##### 推送3: 停止投注信号
```
触发条件: 倒计时结束或荷官强制停止
推送对象: 指定台桌的所有用户
推送内容: 停止投注提示信息
```

##### 推送4: 开奖结果推送
```
触发条件: 荷官通过HTTP接口录入开奖结果
推送对象: 指定台桌的所有用户
推送内容: 三个骰子点数、总点数、大小单双、特殊结果
```

##### 推送5: 个人中奖信息推送
```
触发条件: 开奖结果确定后计算中奖
推送对象: 仅中奖用户个人
推送内容: 中奖金额、中奖投注类型、更新后余额
```

### 2. 非功能需求

#### 2.1 性能要求
- **并发连接**: 支持单台桌50+用户同时在线
- **推送延迟**: 消息推送延迟 < 200ms
- **倒计时精度**: 倒计时误差 < 1秒
- **内存占用**: 单连接内存占用 < 1MB

#### 2.2 可靠性要求
- **连接稳定性**: 连接断开后支持自动重连
- **消息可靠性**: 关键消息(开奖结果)确保送达
- **错误恢复**: 服务重启后用户可重新连接获取状态
- **数据一致性**: 推送内容与数据库数据保持一致

#### 2.3 安全要求
- **身份验证**: 所有连接必须通过user_id + token验证
- **权限控制**: 用户只能加入有权限的台桌
- **数据加密**: WebSocket连接支持WSS加密传输
- **防攻击**: 防止恶意连接和消息轰炸

---

## 🏗️ 技术要求

### 1. 技术栈
- **后端框架**: ThinkPHP6
- **WebSocket服务**: Workerman
- **缓存存储**: Redis
- **数据库**: MySQL
- **PHP版本**: 7.3

### 2. 架构设计

#### 2.1 服务架构
```
HTTP API 服务 ← → Redis ← → WebSocket 服务
     ↓                        ↓
   MySQL                  用户连接
```

#### 2.2 数据流向
```
荷官操作 → HTTP API → Redis → WebSocket Timer → 用户推送
```

#### 2.3 核心组件

##### ConnectionManager (连接管理器)
```php
职责:
- 管理所有WebSocket连接
- 维护用户与连接的映射关系
- 维护台桌与连接的映射关系
- 提供消息发送接口

接口:
- addConnection(connection) // 添加连接
- removeConnection(connection) // 移除连接
- authenticateUser(connectionId, userId) // 用户认证
- joinTable(connectionId, tableId) // 加入台桌
- leaveTable(connectionId, tableId) // 离开台桌
- sendToUser(userId, message) // 发送给用户
- broadcastToTable(tableId, message) // 台桌广播
```

##### MessageHandler (消息处理器)
```php
职责:
- 解析WebSocket消息
- 路由消息到对应处理器
- 处理ping/pong心跳
- 统一错误处理

支持消息:
- ping/pong // 心跳
- auth // 用户认证
- join_table/leave_table // 台桌操作
```

##### NotificationSender (推送发送器)
```php
职责:
- 封装5种核心推送功能
- 提供统一的推送接口
- 处理推送失败重试

推送方法:
- sendGameStart(tableId, gameData) // 推送开始投注
- sendCountdown(tableId, countdown) // 推送倒计时
- sendGameEnd(tableId, gameData) // 推送停止投注
- sendGameResult(tableId, result) // 推送开奖结果
- sendWinInfo(userId, winData) // 推送中奖信息
```

##### GameTimer (游戏定时器)
```php
职责:
- 定时检查Redis游戏状态
- 触发相应的推送操作
- 管理倒计时推送逻辑

定时任务:
- 每秒检查游戏状态变化
- 根据剩余时间决定是否推送倒计时
- 检查新的开奖结果并推送
```

### 3. Redis数据结构

#### 3.1 游戏状态
```redis
Key: sicbo:table:{table_id}:status
Value: {
  "game_number": "T001_20241207_143022_001",
  "status": "betting", // waiting/betting/dealing/result
  "start_time": 1701936622,
  "total_time": 30,
  "table_id": 1,
  "round_number": 1
}
TTL: 3600秒
```

#### 3.2 开奖结果
```redis
Key: sicbo:table:{table_id}:result:{game_number}
Value: {
  "dice1": 3, "dice2": 5, "dice3": 2,
  "total_points": 10,
  "is_big": false, "is_odd": false,
  "has_triple": false,
  "winning_bets": ["small", "even"],
  "result_time": 1701936652
}
TTL: 86400秒 (24小时)
```

#### 3.3 中奖信息
```redis
Key: sicbo:user:{user_id}:win:{game_number}
Value: {
  "user_id": 123,
  "win_amount": 200.00,
  "win_bets": [...],
  "new_balance": 1200.00
}
TTL: 3600秒
```

---

## 📝 开发规范

### 1. 代码规范
- **PSR-4**: 遵循PSR-4自动加载规范
- **PSR-12**: 遵循PSR-12代码风格规范
- **命名规范**: 类名PascalCase，方法名camelCase
- **注释**: 所有public方法必须有完整的PHPDoc注释

### 2. 错误处理
- **统一错误码**: 定义统一的错误码和错误信息
- **日志记录**: 所有错误和关键操作必须记录日志
- **优雅降级**: 非关键功能异常不应影响核心功能
- **错误推送**: 向客户端发送格式化的错误信息

### 3. 性能优化
- **连接池管理**: 合理管理连接资源
- **内存管理**: 及时清理无用数据，防止内存泄漏
- **缓存策略**: 合理使用Redis缓存，设置适当的TTL
- **推送优化**: 避免不必要的推送，减少网络负载

### 4. 安全规范
- **输入验证**: 所有用户输入必须验证
- **SQL注入防护**: 使用参数化查询
- **XSS防护**: 输出内容进行适当转义
- **认证授权**: 严格的用户认证和权限控制

---

## 🧪 测试要求

### 1. 单元测试
- **覆盖率**: 核心逻辑代码覆盖率 > 80%
- **测试框架**: 使用PHPUnit
- **Mock**: 对外部依赖进行Mock测试
- **边界测试**: 测试各种边界条件和异常情况

### 2. 集成测试
- **WebSocket连接**: 测试连接建立、认证、断开流程
- **消息推送**: 测试各种推送场景和消息格式
- **Redis交互**: 测试Redis读写操作
- **HTTP API交互**: 测试与HTTP API的数据交互

### 3. 性能测试
- **并发连接**: 测试支持的最大并发连接数
- **消息吞吐量**: 测试每秒处理的消息数量
- **内存使用**: 监控内存使用情况和泄漏
- **响应时间**: 测试各种操作的响应时间

### 4. 压力测试
- **负载测试**: 模拟正常负载下的系统表现
- **压力测试**: 测试系统的极限承载能力
- **稳定性测试**: 长时间运行的稳定性测试
- **故障恢复**: 测试各种故障情况下的恢复能力

---

## 📊 监控要求

### 1. 系统监控
- **连接数监控**: 实时监控在线连接数量
- **内存使用**: 监控服务器内存使用情况
- **CPU使用**: 监控CPU使用率
- **网络流量**: 监控网络I/O情况

### 2. 业务监控
- **推送成功率**: 监控各类推送的成功率
- **响应时间**: 监控消息推送的响应时间
- **错误率**: 监控系统错误发生率
- **用户活跃度**: 监控用户连接和台桌活跃情况

### 3. 日志记录
- **访问日志**: 记录所有连接和断开日志
- **操作日志**: 记录所有重要操作日志
- **错误日志**: 记录所有错误和异常日志
- **性能日志**: 记录性能相关的关键指标

---

## 🚀 部署要求

### 1. 服务器配置
- **CPU**: 4核心以上
- **内存**: 8GB以上
- **磁盘**: SSD，可用空间100GB以上
- **网络**: 带宽100Mbps以上，低延迟

### 2. 软件环境
- **操作系统**: CentOS 7+ / Ubuntu 18+
- **PHP**: 7.3 (已确定版本)
- **Redis**: 6.0+
- **MySQL**: 5.7+ / 8.0+
- **Nginx**: 反向代理和负载均衡

### 3. 部署架构
```
负载均衡器 (Nginx)
       ↓
WebSocket 服务集群
       ↓
Redis 集群 ← → MySQL 主从
```

### 4. 扩展性要求
- **水平扩展**: 支持多实例部署
- **负载均衡**: 支持连接的负载均衡
- **Redis集群**: 支持Redis集群部署
- **热更新**: 支持不停机更新代码

---

## 📅 开发计划

### 第一阶段 (1-2周): 基础框架
- [ ] 搭建ThinkPHP6 + Workerman WebSocket服务 (PHP 7.3)
- [ ] 配置PHP 7.3运行环境和依赖
- [ ] 实现ConnectionManager连接管理
- [ ] 实现基础的认证和台桌操作
- [ ] 实现ping/pong心跳机制

### 第二阶段 (1-2周): 核心推送
- [ ] 实现Redis数据结构设计
- [ ] 实现GameTimer定时检查机制
- [ ] 实现5种核心推送功能
- [ ] 实现NotificationSender推送器

### 第三阶段 (1周): 测试优化
- [ ] 编写单元测试和集成测试
- [ ] 性能优化和压力测试
- [ ] 错误处理和日志完善
- [ ] 文档完善和代码review

### 第四阶段 (1周): 部署上线
- [ ] 生产环境部署
- [ ] 监控系统搭建
- [ ] 线上测试和调优
- [ ] 正式上线和维护

---

## ✅ 验收标准

### 1. 功能验收
- [ ] 所有5种核心推送功能正常工作
- [ ] 用户认证和台桌操作无误
- [ ] 倒计时推送精确到秒级
- [ ] 开奖结果推送及时准确
- [ ] 个人中奖信息推送正确

### 2. 性能验收
- [ ] 支持单台桌50+用户同时在线
- [ ] 消息推送延迟 < 200ms
- [ ] 系统连续运行24小时无故障
- [ ] 内存使用稳定，无明显泄漏

### 3. 安全验收
- [ ] 用户认证机制完善
- [ ] 无SQL注入等安全漏洞
- [ ] 支持WSS加密传输
- [ ] 防止恶意连接攻击

### 4. 可维护性验收
- [ ] 代码结构清晰，符合ThinkPHP6规范
- [ ] 兼容PHP 7.3版本，无语法错误
- [ ] 日志记录完善，便于调试
- [ ] 监控指标齐全
- [ ] 文档完整，便于后续维护

---

## 📞 联系信息

**项目负责人**: [项目经理姓名]
**技术负责人**: [技术负责人姓名]
**开发团队**: [开发团队信息]

**紧急联系**: [紧急联系方式]
**项目邮箱**: [项目邮箱]

---

*本文档最后更新时间: 2024-12-07*