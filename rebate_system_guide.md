# 洗码费用系统说明文档

## 一、洗码费概念解释

### 1.1 什么是洗码费？
**洗码费**（Rebate/Commission）是博彩平台给予用户的投注返水奖励，相当于"现金回馈"。

### 1.2 洗码费 vs 洗码量
| 项目 | 洗码费 | 洗码量 |
|------|--------|--------|
| **定义** | 平台返给用户的现金 | 用户的有效投注流水 |
| **用途** | 现金奖励/代理分成 | 提款限制/VIP升级 |
| **计算** | 投注额 × 洗码率 | 等于投注金额 |
| **发放** | 需要人工审核发放 | 自动累计记录 |

## 二、洗码费计算规则

### 2.1 基础计算公式
```
洗码费 = 投注金额 × 用户洗码率 ÷ 100
```

### 2.2 计算示例
假设用户洗码率为 **0.8%**：

| 投注金额 | 洗码费计算 | 实际返水 |
|----------|------------|----------|
| 1,000元 | 1,000 × 0.8% | 8元 |
| 5,000元 | 5,000 × 0.8% | 40元 |
| 10,000元 | 10,000 × 0.8% | 80元 |

### 2.3 免佣模式的影响
| 投注模式 | 洗码费 | 说明 |
|----------|--------|------|
| **收佣模式** | 正常计算 | 按用户洗码率返水 |
| **免佣模式** | **0元** | 不产生任何洗码费 |

**重要**：免佣模式下，用户无法获得洗码费返水。

## 三、系统处理流程

### 3.1 下注阶段
```php
// 计算洗码费（仅记录，不发放）
if ($is_exempt == 1) {
    $shuffling_amt = 0;  // 免佣模式：洗码费为0
} else {
    $shuffling_amt = $bet_amount * $user_rebate_rate / 100;  // 收佣模式：按比例计算
}
```

### 3.2 结算阶段
- **正常结算**：洗码费记录保持不变
- **和局退款**：洗码费清零（因为退回本金）

### 3.3 发放阶段
**当前系统设计**：洗码费只做记录，不自动发放

需要通过以下方式发放：
- 管理员后台手动发放
- 定时批量处理任务
- 用户申请返水审核

## 四、特殊情况处理

### 4.1 和局的特殊处理
```
投注情况：用户押庄100元，洗码率0.8%，应得洗码费0.8元
开牌结果：和局（庄闲同点）
处理结果：
- 退回本金：100元
- 洗码费：0元（清零）
- 洗码量：0元（清零）
```

**原因**：和局相当于"无效投注"，不产生任何费用和流水。

### 4.2 代理分成机制
根据代码注释：
- **有代理**：洗码费给代理商
- **无代理**：洗码费返给用户本人

## 五、用户等级与洗码率

### 5.1 洗码率来源
洗码率存储在用户表的 `xima_lv` 字段，通常按用户等级设定：

| 用户等级 | 洗码率 | 月投注要求 |
|----------|--------|------------|
| 普通会员 | 0.5% | 无 |
| 银牌会员 | 0.6% | 50万 |
| 金牌会员 | 0.8% | 100万 |
| 钻石会员 | 1.0% | 200万 |
| 至尊会员 | 1.2% | 500万 |

### 5.2 洗码率的业务意义
- **用户激励**：鼓励持续投注
- **等级差异**：体现VIP特权
- **成本控制**：限制平台返水成本

## 六、财务核算

### 6.1 洗码费的财务处理
```
用户投注：1000元
平台收入：50元（假设5%利润率）
洗码费：8元（0.8%洗码率）
实际利润：42元（50-8）
```

### 6.2 洗码费统计维度
- **按用户统计**：个人洗码费累计
- **按时间统计**：日/周/月洗码费
- **按游戏统计**：不同游戏的洗码费
- **按代理统计**：代理商洗码费分成

## 七、风控要点

### 7.1 洗码费风险控制
1. **人工审核**：防止刷量套利
2. **时间限制**：设定返水申请周期
3. **流水要求**：满足一定投注量才能提现
4. **异常监控**：识别异常投注模式

### 7.2 合规考虑
- **透明计算**：公开洗码率和计算方式
- **定期结算**：按约定周期发放返水
- **记录完整**：保留所有洗码费计算记录

## 八、运营建议

### 8.1 洗码费策略
- **新用户**：提高洗码率吸引注册
- **活跃用户**：通过洗码费提升粘性
- **大客户**：个性化洗码率谈判

### 8.2 发放频率建议
- **日返**：小额洗码费，提升用户体验
- **周返**：中等金额，平衡成本和效果
- **月返**：大额洗码费，降低运营成本

## 九、技术实现要点

### 9.1 数据库字段
```sql
-- 投注记录表字段
shuffling_amt  DECIMAL(10,2)  -- 洗码费金额
shuffling_num  DECIMAL(10,2)  -- 洗码量
shuffling_rate DECIMAL(5,4)   -- 洗码率
is_exempt      TINYINT(1)     -- 是否免佣
```

### 9.2 关键业务逻辑
- 免佣模式洗码费为0
- 和局时洗码费清零
- 只记录不自动发放
- 支持代理分成机制

---

**总结**：洗码费是博彩平台的重要营销工具，通过精确计算和灵活发放，既能吸引用户又能控制成本。当前系统已实现完整的计算和记录功能，后续可根据业务需要添加自动发放机制。